var CustomizeBuilder_V1;!function(r){var l=r(document),c=wp.customize||null,F=Customify_Layout_Builder.is_rtl;CustomizeBuilder_V1=function(n,s){var e={id:s,controlId:"",cols:12,cellHeight:45,items:[],container:null,ready:!1,devices:{desktop:"Desktop",mobile:"Mobile/Tablet"},activePanel:"desktop",panels:{},activeRow:"main",draggingItem:null,getTemplate:_.memoize(function(){var o=this,a={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(e,t,i){return _.isUndefined(t)&&(t="tmpl-customize-control-"+o.type),!_.isUndefined(i)&&_.isString(i)?a.variable=i:a.variable="data",_.template(r("#"+t).html(),null,a)(e)}}),drag_drop:function(){var n=this;r(".customify--device-panel",n.container).each(function(){var i=r(this),o=i.data("device"),a=[];n.panels[o]={},r(".customify--cb-items",i).each(function(e){var t=r(this).attr("data-id")||"",i=t?"_sid_"+o+"-"+t:"_sid_"+o+e;r(this).attr("id",i),a[e]="#"+i}),r(".grid-stack",i).each(function(){var e=r(this).attr("data-id")||"";n.panels[o][e]=r(this),r(this).droppable({out:function(e,t){},over:function(e,t){},drop:function(e,t){var i=r(this);n.gridster(i,t,e),n.save()}})});var e=r("#_sid_mobile-sidebar",i),t=e.attr("id")||!1;r(".customify-available-items .grid-stack-item",i).draggable({revert:"invalid",connectToSortable:!!t&&"#"+t,start:function(e,t){r("body").addClass("builder-item-moving"),r(".customify--cb-items",i).css("z-index",""),t.helper.parent().css("z-index",9999)},stop:function(e,t){r("body").removeClass("builder-item-moving"),r(".customify--cb-items",i).css("z-index",""),t.helper.parent().css("z-index","")}}),0<e.length&&(e.sortable({revert:!0,change:function(e,t){n.save()},receive:function(e,t){r(this).find(".grid-stack-item").removeAttr("style").attr("data-gs-width",1),n.save()}}),n.panels[o].sidebar=e),r(".customify-available-items .grid-stack-item",i).resizable({handles:"w, e",stop:function(e,t){n.setGridWidth(t.element.parent(),t),n.save()}})})},sortGrid:function(e){r(".grid-stack-item",e).each(function(){var e,t=r(this),i=t.attr("data-gs-x")||0,i=parseInt(i),o=t.next();0<o.length&&(e=o.attr("data-gs-x")||0,(e=parseInt(e))<i&&t.insertAfter(o))})},getX:function(e){var t=e.attr("data-gs-x")||0;return parseInt(t)},getW:function(e,t){var i;return _.isUndefined(t)&&(t=!1),i=t?e.attr("data-df-width")||1:e.attr("data-gs-width")||1,parseInt(i)},gridGetItemInfo:function(e,t,i){for(var o=this.getX(e),a=this.getW(e),n=0,s=0,r=!1,l=o-1;0<=l&&!r;)0===t[l]?n++:r=!0,l--;for(r=!1,l=o+a;l<this.cols&&!r;)0===t[l]?s++:r=!0,l++;return{flag:t,x:o,w:a,item:e,before:n,after:s,id:e.attr("data-id")||"",wrapper:i}},updateItemsPositions:function(e){for(var t=this.cols,i=0;i<=t;i++)"object"!=typeof e[i]&&"function"!=typeof e[i]||e[i].attr("data-gs-x",i)},gridster:function(e,t,i){function v(e){for(var t=e.x,i=e.w,o=e.el,a=t;a<t+i;a++)C[a]=a===t?o:1}function l(e){for(var t=e.x,i=e.w,o=(e.el,t);o<t+i;o++)C[o]=0}function m(e,t){for(var i=0,o=e;o<D;o++)if(0===C[o])i++;else if(t)return i;return i}function p(e,t){var i=0;void 0===t&&(t=!1);for(var o=e;0<=o;o--)if(0===C[o])i++;else if(t)return i;return i}function h(e){return 0===C[e]}function w(e,t){for(var i=e;i<e+t;){if(0!==C[i])return;i++}return 1}function b(e){if(e<0)return{x:-1,w:1};var t,i,o,a=-1;if(C[e]<=1)for(t=e,o=!1;0<=t&&!o;)1!==C[t]&&0!==C[t]&&(a=t,o=!0),t--;else a=e;for(t=a+1,i=a;1===C[t];)i++,t++;return{x:a,w:i+1-a}}function x(e){var t,i,o,a=-1;if(C[e]<D)for(t=e,o=!1;t<D&&!o;)1!==C[t]&&0!==C[t]&&(a=t,o=!0),t++;else a=e;for(t=a+1,i=a;1===C[t];)i++,t++;return{x:a,w:i+1-a}}function y(e,t){var i=C.slice(),o=p(e);if(0===o)return t;for(var a=b(e),n=0<=a.x?a.x+a.w-1:e,s=t,s=o<t?o:t,r=0,l=0,c=n;l<=s&&0<=c;)0===C[c]&&(l++,r=c),c--;for(var d=[],f=0,c=r;c<=n;c++)(C[c]=0)!==i[c]&&(d[f]=i[c],f++);for(f=0,c=r;c<=n;c++)void 0!==d[f]?C[c]=d[f]:C[c]=0,f++;return t-s}function I(e,t){var i=C.slice(),o=m(e);if(0===o)return t;for(var a=b(e),n=0<=a.x?a.x:e,s=t,s=t<=o?t:o,r=e,l=0,c=n;l<s&&c<D;)0===C[c]&&(l++,r=c),c++;for(var d=[],f=0,c=n;c<=r;c++)(C[c]=0)!==i[c]&&(d[f]=i[c],f++);for(f=d.length-1,c=r;n<=c;c--)void 0!==d[f]?C[c]=d[f]:C[c]=0,f--;return t-s}function z(){P.updateItemsPositions(C)}function c(e,t){var i,o,a,n,d=e.x,s=e.w,r=function(){for(var e=0,t=0;t<D;t++)0===C[t]&&e++;return e}();if(r<=0)return!1;if(_.isUndefined(t)&&(t=!1),!t){if(h(d)){if(w(d,n=s))return v(e),e.el.attr("data-gs-x",d),e.el.attr("data-gs-width",n),!0;for((i=s<=(o=m(d,!0))+(a=p(d-1,!0))&&s-o<=a?d-(s-o):d-a)<0&&(i=0),console.log("_re",o),console.log("_le",a),console.log("__x",i);1<=n;){if(w(i,n))return console.log({x:i,w:n}),e.x=i,e.w=n,v(e),e.el.attr("data-gs-x",i),e.el.attr("data-gs-width",n),!0;n--}}if(1===C[d]){var l=b(d);if(0<=l.x&&d>l.x+Math.floor(l.w/2)&&d>l.x&&(i=l.x+l.w,o=m(i,!0),console.log("__re",o),console.log("__re_X",i),s<=o))return v({el:e.el,x:i,w:s}),e.el.attr("data-gs-x",i),e.el.attr("data-gs-width",s),!0}}console.log("--------------------------------------------------------"),function(e,t){var i,o,a,n,s=0,r=!1;if(console.log("insert at x",t),console.log("insert node",e),h(t)){if(console.log("empty_at_X",t),i=b(t),o=x(t),-1<i.x){if(console.log("found_item_left",i),(s=m(i.x))>=e.w)if(w(t,e.w))console.log("found",e),d=t,r=!0;else if(e.ox>t)for(a=i.x+i.w,n=(n=p(a))<=e.w?e.w-n:e.w,I(a+1,n),s=m(a),console.log("loop_start_i",a),r=!1;a>i.x+i.w&&!r;)w(a,e.w)&&(console.log("found_in_loop__i",a),d=a,r=!0),a--;if(!r&&e.ox<t){console.log("try_move_items_to_left",i),a=i.x+i.w-1,n=p(i.x),console.log("el",n),n>e.w&&(n=e.w),n-=2,y(i.x,n),console.log("try_move_items_to_left_flag",C),console.log("el2",n),a-=s=m(a),o=x(t);var l=i.x+i.w;for(-1<o.x&&(l=o.x),console.log("loop_start 2_i",a);a<l&&!r;)w(a,e.w)&&(console.log("found_in_loop__@__i",a),d=a,r=!0),a++}r||(d=i.x+i.w,e.w=s,e.x=d,console.log("resize_new_w",s),console.log("resize_new_x",d))}else if(-1<o.x){console.log("found_item_right",o),o=x(t),s=m(t,!1),console.log("move_all_item_to Right");var c=s>=e.w?e.w:s;for(I(t,c),a=o.x,console.log("loop_start Right",a);0<=a&&!r;)w(a,e.w)&&(d=a,e.x=d,r=!0,console.log("found_in_while_r",a)),a--;r||(d=t,e.w=s,e.x=d,console.log("resize_r_new_w",s),console.log("resize_r_new_x",d))}}else if(console.log("x is not empty"),i=b(t),e.ox<i.x)if(y(t,e.w),console.log("Move All items to left"),h(t))d=t;else{for(;!h(t)&&t<=P.cols-1;)t++;d=t}else if(I(t,e.w),console.log("Move All items to right"),h(t))d=t;else{for(;!h(t)&&0<=t;)t--;d=t}d>P.cols&&(d=P.cols-1),e.x=d,console.log("new node x",d)}(e,_.clone(d));var c,f,u=!1,g=0;for(d+s>P.cols-1&&(g=p(d,!0),console.log("le",g),0<g&&console.log("move_Left",d+s-P.cols-1)),z(),g=0;1<=s;){if(s<=r){if(w(d,s))return console.log("",{x:d,w:s}),e.w=s,v(e),e.el.attr("data-gs-x",d),e.el.attr("data-gs-width",s),!0;for(g=p(d,!(u=!1)),c=d-g,console.log("newX",c),f=c;f<D&&!u;){if(w(f,s))return console.log("Insert in While",{x:f,w:s}),e.w=s,v({el:e.el,x:f,w:s}),e.el.attr("data-gs-x",f),e.el.attr("data-gs-width",s),u=!0;f++}}s--}for(s=e.w,u=!1;1<=s;){for(f=0;f<D&&!u;){if(w(f,s))return console.log("Insert in While 2",{x:f,w:s}),v({el:e.el,x:f,w:s}),e.el.attr("data-gs-x",f),e.el.attr("data-gs-width",s),u=!0;f++}s--}return console.log("Insert END While",{x:f,w:s}),!1}var C=[],P=this,D=this.cols,o=(C=(P=this).getFlag(e)).slice(),a=e.offset();P.draggingItem=t.draggable;var n,s=e.width(),r=s/P.cols,d=0,f=t.offset,u=P.getW(t.draggable,!1),g=P.getW(t.draggable,!0),k=t.draggable.width();console.log("DROP ITEM WIDTH",g),console.log("DROP ITEM cw WIDTH",u);var A=P.getX(t.draggable);F&&l({el:t.draggable,x:A,w:g});var S,T=0,M=0,G=!1;if(t.draggable.parent().is(e)?(n=!0,console.log("Item in this row"),g=u):(n=!1,console.log("Not in this row"),g<u&&(g=u)),F?(T=Math.round((a.left+s+10-i.clientX)/r),(M=Math.round((a.left+s-(f.left+k+10))/r))<0&&(M=0)):(T=Math.round((i.clientX-a.left)/r),(M=Math.round((f.left-a.left-10)/r))<0&&(M=0)),T>P.cols&&(T=P.cols),S=d=M,F)if(h(S))d=M,G=!0;else for(;S<P.cols&&!G;)h(S)?G=!0:S++;else if(h(d))d=M,G=!0;else{for(;d<=T&&!G;)h(d)?G=!0:d++;T<d&&(d=T)}if(G||(d=n?M:T),d<0&&(d=0),d+g>=P.cols){for(G=!0,S=d;S+g>P.cols&&G;)h(S)?S--:(S++,G=!1),console.log("loop_i",S);console.log("Find new _i, w: "+g,S),d=S}delete G,console.log("DROP Cursor",T),console.log("DROP row x cacl",d),console.log("DROP item w",g);var R={el:t.draggable,x:d,w:g,ox:A,ow:u};R.x<=0&&(R.x=0);var W=!1;n?(R.x=parseInt(t.draggable.attr("data-gs-x")||0),R.w=parseInt(t.draggable.attr("data-gs-width")||1),console.log("swap node",R),function(e,t){e.x;var i=e.w;l(e),console.log("Swap newX",t),console.log("Before Swap FLAG",C);var o=b(t),a=0;if(-1<o.x&&(a=o.x+o.w),w(t,i))return v({el:e.el,x:t,w:i});if(0<a&&w(a,i)&&a<=t){var n=x(t);if(-1<n.x&&e.w+t>=n.x)for(var s=_.clone(t);a<s;){if(w(s,i))return v({el:e.el,x:s,w:i});s--}if(t+i>P.cols){var r=P.cols-i;if(w(r,i))return v({el:e.el,x:r,w:i})}return v({el:e.el,x:a,w:i})}e.x=t,c(e,!0)}(R,d),W=!0):(W=c(R),console.log("Insert node")),W?(t.draggable.removeClass("item-from-list"),e.append(t.draggable),t.draggable.removeAttr("style"),console.log("DID Flag: ",C),P.draggingItem=null):(t.draggable.removeAttr("style"),console.log("Can not insert"),C=o),z(),P.updateAllGrids()},updateAllGrids:function(){var i=this;_.each(i.panels[i.activePanel],function(e,t){i.updateGridFlag(e)})},setGridWidth:function(e,t){var i,o,a,n,s,r=this,l=t.element,c=e.width(),d=t.size.width,f=t.originalSize.width,u=Math.ceil(c/r.cols)-1,g=F?(i=t.originalPosition.left>t.position.left,f!==d):(i=t.originalPosition.left>t.position.left,t.originalPosition.left<t.position.left),v=t.originalElement.attr("data-gs-width")||1,m=t.originalElement.attr("data-gs-x")||0,v=parseInt(v),m=parseInt(m),p=r.getFlag(e),h=r.gridGetItemInfo(t.originalElement,p,e);if(i)return F?(a=Math.floor((t.position.left-1)/u),(o=(a=r.cols-a)-m-v)>h.after&&(o=h.after),n=v+o,l.attr("data-gs-x",m).removeAttr("style")):((o=m-(a=Math.floor((t.position.left-1)/u)))>h.before&&(o=h.before),a=m-o,n=v+o,l.attr("data-gs-x",a).removeAttr("style")),l.attr("data-gs-width",n).removeAttr("style"),void r.updateGridFlag(e);if(g)return F?t.originalPosition.left!==t.position.left?(a=Math.floor((t.position.left-1)/u),v<(o=v+m-(a=r.cols-a))&&(o=0),n=v-o,(a=m)<=0&&(a=0),console.log("diffRight_RTL_COL_New __left")):(a=Math.ceil((t.position.left+t.size.width-11)/u),(o=m-(a=r.cols-a))>h.before&&(o=h.before),a=m-o,n=v+o):((n=v-(o=(a=Math.round((t.position.left-1)/u))-m))<=0&&(n=1,o=0),a=m+o),l.attr("data-gs-x",a).removeAttr("style"),l.attr("data-gs-width",n).removeAttr("style"),void r.updateGridFlag(e);var w,_=h.x;d<t.originalSize.width?((w=Math.round((t.position.left+t.size.width-11)/u))<=_&&(w=_+1),s=h.w-(_+h.w-w)):(w=Math.ceil((t.position.left+t.size.width-11)/u),s=h.w+(w-(_+h.w)),h.x+s>h.x+h.w+h.after&&(s=h.w+h.after)),s<=0&&(s=1),l.attr("data-gs-width",s).removeAttr("style"),r.updateGridFlag(e)},getFlag:function(e){var t,i=e.data("gridRowFlag")||[];if(_.isEmpty(i)){for(t=0;t<this.cols;t++)i[t]=0;e.data("gridRowFlag",i)}return i},updateGridFlag:function(e){for(var o=this,a=[],n=0;n<o.cols;n++)a[n]=0;return r(".grid-stack-item",e).each(function(e){r(this).removeAttr("style");var t=o.getX(r(this)),i=o.getW(r(this));for(n=t;n<t+i;n++)a[n]=n===t?r(this):1}),e.data("gridRowFlag",a),o.updateItemsPositions(a),o.sortGrid(e),a},addNewWidget:function(e,t){var i=this,o=i.container.find(".customify--device-panel.customify--panel-"+i.activePanel),a=t;_.isObject(a)||(a=o.find(".customify--cb-items").first());var n=e;n.draggable({revert:"invalid",appendTo:o,scroll:!1,zIndex:99999,handle:".grid-stack-item-content",start:function(e,t){r("body").addClass("builder-item-moving"),r(".customify--cb-items",o).css("z-index",""),t.helper.parent().css("z-index",9999)},stop:function(e,t){r("body").removeClass("builder-item-moving"),r(".customify--cb-items",o).css("z-index",""),i.save()},drag:function(e,t){}}).resizable({handles:"w, e",start:function(e,t){t.originalElement.css({right:"auto",left:t.position.left})},stop:function(e,t){i.setGridWidth(t.element.parent(),t),i.save()}}),a.append(n),i.updateGridFlag(a)},addPanel:function(e){var t=this.getTemplate(),i="tmpl-customify--cb-panel";if(0!=r("#"+i).length)return _.isObject(n.rows)||(n.rows={}),'<div class="customify--device-panel customify-vertical-panel customify--panel-'+e+'" data-device="'+e+'">'+t({device:e,id:n.id,rows:n.rows},i)+"</div>"},addDevicePanels:function(){var o=this;_.each(o.devices,function(e,t){var i=o.addPanel(t);r(".customify--cb-devices-switcher",o.container).append('<a href="#" class="switch-to switch-to-'+t+'" data-device="'+t+'">'+e+"</a>"),r(".customify--cb-body",o.container).append(i)}),r("#customify-upsell-tmpl").length&&r(r("#customify-upsell-tmpl").html()).insertAfter(r(".customify--cb-devices-switcher",o.container))},addItem:function(e){var t=this.getTemplate(),i="tmpl-customify--cb-item";if(0!=r("#"+i).length){var o=t(e,i);return r(o)}},addAvailableItems:function(){var s=this;_.each(s.devices,function(e,a){var n=r('<div class="customify-available-items" data-device="'+a+'"></div>');r(".customify--panel-"+a,s.container).append(n),_.each(s.items,function(e){var t,i,o=!0;_.isUndefined(e.devices)||_.isEmpty(e.devices)||(_.isString(e.devices)?e.devices!=a&&(o=!1):(t=!1,_.each(e.devices,function(e){a==e&&(t=!0)}),t||(o=!1))),o&&(i=s.addItem(e),n.append(i))})})},switchToDevice:function(e,t){var i=this;1<_.size(i.devices)?(r(".customify--cb-devices-switcher a",i.container).removeClass("customify--tab-active"),r(".customify--cb-devices-switcher .switch-to-"+e,i.container).addClass("customify--tab-active"),r(".customify--device-panel",i.container).addClass("customify--panel-hide"),r(".customify--device-panel.customify--panel-"+e,i.container).removeClass("customify--panel-hide"),i.activePanel=e):r(".customify--cb-devices-switcher a",i.container).addClass("customify--tab-active"),(_.isUndefined(t)||t)&&("desktop"==e?r("#customize-footer-actions .preview-desktop").trigger("click"):r("#customize-footer-actions .preview-mobile").trigger("click"))},addExistingRowsItems:function(){var s=this,t=c.control(s.controlId).params.value;_.isObject(t)||(t={}),_.each(s.panels,function(a,n){var e={};_.isObject(t[n])&&(e=t[n]),_.each(e,function(e,o){_.isUndefined(e)||_.each(e,function(e,t){var i=r('.customify-available-items[data-device="'+n+'"] .grid-stack-item[data-id="'+e.id+'"]').first();i.attr("data-gs-width",e.width),i.attr("data-gs-x",e.x),i.removeClass("item-from-list"),s.addNewWidget(i,a[o])})})}),s.ready=!0},focus:function(){this.container.on("click",".customify--cb-item-setting, .customify--cb-item-name, .item-tooltip",function(e){e.preventDefault();var t=r(this).data("section")||"",i=r(this).attr("data-control")||"",o=!1;i&&(_.isUndefined(c.control(i))||(c.control(i).focus(),o=!0)),o||t&&!_.isUndefined(c.section(t))&&(c.section(t).focus(),o=!0)}),this.container.on("click",".customify--cb-row-settings",function(e){e.preventDefault();var t=r(this).attr("data-id")||"",i=n.id+"_"+t;_.isUndefined(c.section(i))||c.section(i).focus()})},remove:function(){var o=this;l.on("click",".customify--device-panel .customify--cb-item-remove",function(e){e.preventDefault();var t=r(this).closest(".grid-stack-item"),i=t.closest(".customify--device-panel");t.attr("data-gs-width",1),t.attr("data-gs-x",0),t.removeAttr("style"),r(".customify-available-items",i).append(t),o.updateAllGrids(),o.save()})},encodeValue:function(e){return encodeURI(JSON.stringify(e))},decodeValue:function(e){return JSON.parse(decodeURI(e))},save:function(){var a,n=this;n.ready&&(a={},_.each(n.panels,function(e,o){a[o]={},_.each(e,function(e,t){var i=_.map(r(" > .grid-stack-item",e),function(e){return e=r(e),{x:n.getX(e),y:1,width:n.getW(e),height:1,id:e.data("id")||""}});a[o][t]=i})}),c.control(n.controlId).setting.set(n.encodeValue(a)))},showPanel:function(){var t=this;this.container.removeClass("customify--builder--hide").addClass("customify--builder-show"),setTimeout(function(){var e=t.container.height();r("#customize-preview").addClass("cb--preview-panel-show").css({bottom:e-1,"margin-top":"0px"})},100)},hidePanel:function(){this.container.removeClass("customify--builder-show"),r("#customize-preview").removeClass("cb--preview-panel-show").removeAttr("style")},togglePanel:function(){var t=this;c.state("expandedPanel").bind(function(e){c.panel(n.panel).expanded()?(l.trigger("customify_panel_builder_open",[n.panel]),console.log("open-builder:",n.panel),top._current_builder_panel=s,t.showPanel()):t.hidePanel()}),t.container.on("click",".customify--panel-close",function(e){e.preventDefault(),t.container.toggleClass("customify--builder--hide"),t.container.hasClass("customify--builder--hide")?r("#customize-preview").removeClass("cb--preview-panel-show"):r("#customize-preview").addClass("cb--preview-panel-show")})},panelLayoutCSS:function(){var e=r("#customize-controls").width();c.state("paneVisible").get()||(e=0),F?this.container.find(".customify--cb-inner").css({"margin-right":e}):this.container.find(".customify--cb-inner").css({"margin-left":e})},init:function(e,t,i){var o=this,a=o.getTemplate()(n,"tmpl-customify--builder-panel");o.container=r(a),r("body .wp-full-overlay").append(o.container),o.controlId=e,o.items=t,o.devices=i,n.section&&c.section(n.section).container.addClass("customify--hide"),o.addDevicePanels(),o.switchToDevice(o.activePanel),o.addAvailableItems(),o.switchToDevice(o.activePanel),o.drag_drop(),o.focus(),o.remove(),o.addExistingRowsItems(),c.panel(n.panel).expanded()?(console.log("open-builder:",n.panel),o.showPanel()):o.hidePanel(),c.previewedDevice.bind(function(e){"desktop"===e?o.switchToDevice("desktop",!1):o.switchToDevice("mobile",!1)}),o.togglePanel(),c.state("paneVisible").get()&&o.panelLayoutCSS(),c.state("paneVisible").bind(function(){o.panelLayoutCSS()}),r(window).resize(_.throttle(function(){o.panelLayoutCSS()},100)),o.container.on("click",".customify--cb-devices-switcher a.switch-to",function(e){e.preventDefault();var t=r(this).data("device");o.switchToDevice(t)}),l.trigger("customify_builder_panel_loaded",[s,o])}};return e.init(n.control_id,n.items,n.devices),e}}(jQuery);